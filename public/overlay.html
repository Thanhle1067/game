<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>OBS Gift Bars</title>
  <link rel="preload" href="./assets/jail.png" as="image">
  <style>
    :root{
      --w: 1080px;
      --h: 1920px;
    }
    html, body { margin:0; height:100%; background:transparent; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
           color: #fff; overflow:hidden; }
    .stage { position:relative; width:100vw; height:100vh; }
    .bars {
      position:absolute; inset:0;
      background: url('./assets/jail.png') center center / contain no-repeat;
      filter: drop-shadow(0 4px 16px rgba(0,0,0,.6));
    }
    .sliderTrack {
      position:absolute; left:8%; right:8%; bottom:20%;
      height: 26px; border-radius: 999px;
      background: rgba(0,0,0,.5); backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,.15);
      overflow: hidden;
    }
    .sliderThumb {
      position:absolute; top:0; left:0;
      height: 100%; width: 18%;
      background: linear-gradient(180deg,#ffb703,#fb8500);
      box-shadow: 0 6px 20px rgba(251,133,0,.5);
      border-radius: 999px;
      transform: translateX(0);
      transition: transform .25s cubic-bezier(.2,.8,.2,1);
    }
    .timer {
      position:absolute; width:100%;
      top: 8%; text-align:center;
      font-weight: 800; letter-spacing: .02em;
      text-shadow: 0 4px 22px rgba(0,0,0,.65);
    }
    .timer .big { font-size: clamp(48px, 12vw, 140px); }
    .pill {
      display:inline-block; padding:6px 12px; margin-top:8px;
      border:1px solid rgba(255,255,255,.2);
      background: rgba(0,0,0,.35);
      border-radius:999px; font-size: clamp(12px,2.8vw,18px);
    }
    .toast {
      position:absolute; left:50%; top:50%;
      transform: translate(-50%,-50%) scale(0.9);
      padding: 14px 18px; border-radius: 14px;
      background: rgba(0,0,0,.7);
      border:1px solid rgba(255,255,255,.15);
      opacity:0; pointer-events:none;
      transition: all .25s ease;
      font-weight:700;
    }
    .toast.show { opacity:1; transform: translate(-50%,-50%) scale(1); }
    .label { position:absolute; bottom: 24%; width:100%; text-align:center; font-weight:700; opacity:.9 }
  </style>
</head>
<body>
  <div class="stage">
    <div class="bars" aria-hidden="true"></div>

    <div class="timer">
      <div class="big" id="time">00</div>
      <div class="pill" id="status">ƒêang ch·ªù qu√†...</div>
    </div>

    <div class="sliderTrack">
      <div class="sliderThumb" id="thumb"></div>
    </div>
    <div class="label">Song s·∫Øt k√©o t·ª´ tr√°i ‚ûú ph·∫£i</div>

    <div class="toast" id="toast">+5s</div>
  </div>

<script>
  // Helper: query params
  const q = new URLSearchParams(location.search);
  const room = q.get('u') || 'default';
  const maxRange = parseInt(q.get('max') || '60',10);  // mapping window for slider (seconds)
  const init = parseInt(q.get('init') || '0',10);      // initial seconds

  const timeEl = document.getElementById('time');
  const statusEl = document.getElementById('status');
  const thumb = document.getElementById('thumb');
  const toast = document.getElementById('toast');

  let remaining = 0;
  let last = Date.now();

  function fmt(n){ return n.toString().padStart(2,'0'); }

  function setRemaining(r){
    remaining = Math.max(0, r|0);
    timeEl.textContent = fmt(remaining);
    const track = document.querySelector('.sliderTrack');
    const travel = track.clientWidth - thumb.clientWidth;

    if (remaining === 0) {
      // K√©o v·ªÅ tr√°i khi h·∫øt gi·ªù
      thumb.style.transition = 'transform 0.8s ease-in-out';
      thumb.style.transform  = 'translateX(0px)';
    } else {
      const pct = Math.max(0, Math.min(1, remaining / maxRange));
      thumb.style.transition = 'transform .25s cubic-bezier(.2,.8,.2,1)';
      thumb.style.transform  = `translateX(${pct * travel}px)`;
    }

    statusEl.textContent = remaining > 0 ? 'ƒêang ƒë·∫øm ng∆∞·ª£c' : 'H·∫øt gi·ªù';
  }

  function popToast(text){
    toast.textContent = text;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 650);
  }

  // Connect SSE
  const streamURL = `/api/stream?u=${encodeURIComponent(room)}&init=${init}`;
  const es = new EventSource(streamURL);
  es.onmessage = (e)=>{
    const data = JSON.parse(e.data||"{}");
    if (data.type === 'tick') setRemaining(data.remaining);
    else if (data.type === 'gift') { setRemaining(data.remaining); popToast(`+${Math.abs(data.delta)}s`); }
    else if (data.type === 'rescue') { setRemaining(data.remaining); popToast(`-${Math.abs(data.delta)}s üîì Gi·∫£i c·ª©u`); }
  };
  es.addEventListener('hello', e => {
    const d = JSON.parse(e.data||"{}");
    setRemaining(d.remaining||0);
  });

  // For manual testing in OBS/browser console
  window._demo = {
    add:(s=5)=>fetch(`/api/gift?u=${encodeURIComponent(room)}&sec=${s}`),
    rescue:(s=5)=>fetch(`/api/rescue?u=${encodeURIComponent(room)}&sec=${s}`)
  };
</script>
</body>
</html>
